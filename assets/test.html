<!DOCTYPE html>
<html style="background-image: url(bg.jpg);">
	<head>
		<link rel="stylesheet" type="text/css" href="style2.css" />
		<script type="text/javascript" src='jquery.js'></script>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	</head>
	<body>
		<!--textarea style="resize: none" rows="3"></textarea-->

	<script>

		function selectElementContents(el) {
    var range = document.createRange();
    range.selectNodeContents(el);
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
}

		$(document).on('mousedown', '.icon:not(.icon-selected)', function() {
			$('.icon-selected').removeClass('icon-selected');
			$(this).addClass('icon-selected')
		});

		$(document).on('keydown', function(event) {

			var selected = $('.icon-selected');
			if (!selected.length) return;

			if (event.which === 27) {
				$('.icon-rename', selected).remove();
				return false;
			}


			else if (event.which === 13) {
		
				var renamer = $('.icon-rename', selected);
		
				if (renamer.length) {
					var text = renamer.text();
					renamer.closest('.icon').data('text', text);
					renamer.remove();
					var splittedText = fitText(text);
					$('.icon-firstLine', selected).html(splittedText[0] || '');
					$('.icon-secondLine', selected).html(splittedText[1] || '');
					$('.icon-thirdLine', selected).html(splittedText[2] || '');
				}

				else {
					var h = $('.icon-firstLine', selected)[0].offsetHeight * 3;
					var foo = $(`<div class="icon-rename" style="max-height: ${h}px; " contenteditable="true">${selected.data('text')}</div>`);
					foo.prependTo($('.icon-lines', selected))
					foo.focus();
					selectElementContents(foo[0])
				}

				return false;
			}






			// .focus();



		});


		$(document).on('input', '.myAREA', function() {

			var lines = 1;
			var splitted = splitText(this.innerText, maxTextWidth);
			
			if (splitted[1]) {
				lines++;
				splitted = splitText(splitted[1], maxTextWidth);
				if (splitted[1]) {
					lines++;
				}
			}

			$(this).css({
				// height: lines * (fontSize * 1)
			})
		});

		function getCSSVar(varName) {
			return getComputedStyle(document.documentElement).getPropertyValue(varName);
		}

		var ctx = document.createElement('canvas').getContext('2d');
		var fontSize = parseInt(getCSSVar('--icon-font-size'), 10);
		ctx.font = [getCSSVar('--icon-font-size'), getCSSVar('--icon-font-family')].join(' ');
			
		var borderLeftRight = parseInt(getCSSVar('--border-size'), 10) * 4;
		var maxTextWidth = parseInt(getCSSVar('--icon-size'), 10) - parseInt(getCSSVar('--padding-left-right'), 10) * 2;

		function splitText(text, maxWidth) {
			var firstLine = '';
			text = text.split('');
			while (text.length) {
				var size = ctx.measureText(firstLine + text[0]).width;
				if (size > maxWidth) break;
				firstLine += text.shift();
			}
			return [firstLine, text.join('')];
		}

		function fitText(text) {
			
			var result = splitText(text, maxTextWidth);
			var firstLine = result[0];
			var secondLine = result[1];
			if (!secondLine.length) return [firstLine, ''];

			var firstLineWidth = ctx.measureText(firstLine).width;
			var secondLineWidth = ctx.measureText(secondLine).width;

			if (secondLineWidth + borderLeftRight <= firstLineWidth)
				return [firstLine, secondLine];

			if (secondLineWidth <= firstLineWidth)
				return [firstLine, '', secondLine];

			var xStr = '...' + secondLine.slice(-6);
			var xWidth = ctx.measureText(xStr).width;


			return [firstLine, '', splitText(secondLine.slice(0, -6), firstLineWidth - xWidth)[0] + xStr];
		}
		

		function addIcon(text) {
			var splittedText = fitText(text);

			var el = $(`
				<div class="icon" draggable="true" data-text="${text}">
					<div class="icon-image">
						<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="
						style="background-image: url('${Math.floor(Math.random() * 18) + 1}.png');" />
					</div>
					<div class="icon-label">

						<div class="icon-lines">
							<div class="icon-line1">
								<div class="icon-firstLine"></div>
								<div class="icon-thirdLine"></div>
							</div>
							<div class="icon-line2">
								<div class="icon-secondLine"></div>
								<div class="icon-borderSegment icon-borderSegmentLeft"></div>
								<div class="icon-borderSegment icon-borderSegmentRight"></div>
							</div>
						</div>


					</div>
				</div>
			`);

			$('.icon-firstLine', el).html(splittedText[0]);
			$('.icon-secondLine', el).html(splittedText[1]);
			$('.icon-thirdLine', el).html(splittedText[2]);

			$('body').append(el)
		}


		function generate_random_string(string_length){
    let random_string = '';
    let random_ascii;
    for(let i = 0; i < string_length; i++) {
        random_ascii = Math.floor((Math.random() * 25) + 97);
        random_string += String.fromCharCode(random_ascii)
    }
    return random_string
}


		for (var c = 0; c < 30; c++) 
			addIcon(generate_random_string(Math.floor(Math.random() * 60) + 4) + '.jpg');


	</script>

</body>
</html>
